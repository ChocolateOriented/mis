<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mo9.risk.modules.dunning.dao.TMisRemittanceMessageDao">
    
	<sql id="tMisRemittanceMessageColumns">
		a.dbid AS "dbid",
		a.id AS "id",
		a.remittancename AS "remittanceName",
		a.remittancetime AS "remittanceTime",
		a.remittanceamount AS "remittanceAmount",
		a.remittancechannel AS "remittanceChannel",
		a.remittanceaccount AS "remittanceAccount",
		a.financialuser AS "financialUser",
		a.financialtime AS "financialTime",
		a.dealcode AS "dealcode",
		a.remark AS "remark",
		a.createdate AS "createDate",
		a.remittanceSerialNumber AS "remittanceSerialNumber",
		a.accountStatus AS "accountStatus",
		a.remittanceTag AS "remittanceTag"
	</sql>
	
	<sql id="tMisRemittanceMessageJoins">
	</sql>
    
	<select id="get" resultType="TMisRemittanceMessage">
		SELECT 
			<include refid="tMisRemittanceMessageColumns"/>
		FROM t_mis_remittance_message a
		<include refid="tMisRemittanceMessageJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="TMisRemittanceMessage">
		SELECT 
			<include refid="tMisRemittanceMessageColumns"/>
		FROM t_mis_remittance_message a
		<include refid="tMisRemittanceMessageJoins"/>
		<where>
			<if test="remittancename != null and remittancename != ''">
				AND a.remittancename = #{remittancename}
			</if>
			<if test="remittancetime != null and remittancetime != ''">
				AND a.remittancetime = #{remittancetime}
			</if>
			<if test="remittancechannel != null and remittancechannel != ''">
				AND a.remittancechannel = #{remittancechannel}
			</if>
			<if test="financialuser != null and financialuser != ''">
				AND a.financialuser = #{financialuser}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="TMisRemittanceMessage">
		SELECT 
			<include refid="tMisRemittanceMessageColumns"/>
		FROM t_mis_remittance_message a
		<include refid="tMisRemittanceMessageJoins"/>
		<where>
			
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<select id="findRemittanceMesListByDealcode" resultType="TMisRemittanceMessage">
		SELECT 
			<include refid="tMisRemittanceMessageColumns"/>
		FROM t_mis_remittance_message a
			WHERE a.dealcode = #{dealcode}
		ORDER BY a.createdate DESC limit  1 
	</select>
	
	<select id="findBySerialNumbers" resultType="TMisRemittanceMessage">
			select
			<include refid="tMisRemittanceMessageColumns"/>
			from t_mis_remittance_message a
			where
			a.remittanceSerialNumber  in
			<foreach collection="list" item="tMisRemittanceMessage"  index="index"  separator="," open="(" close=")">
			   #{tMisRemittanceMessage.remittanceSerialNumber}
			</foreach>
			and
			a.remittancechannel = #{channel}
	</select>

	<insert id="saveList" parameterType="java.util.List">
		insert into t_mis_remittance_message
		(
			id,
			remittancename,
			remittancetime,
			remittanceamount,
			remittancechannel,
			remittanceaccount,
			financialuser,
			financialtime,
			dealcode,
			remark,
			createDate,
			remittanceSerialNumber,
			accountStatus,
			updateDate,
			updateby
		)
		values
		<foreach collection="list" index="index" item="item" separator="," >
		(
			#{item.id},
			#{item.remittanceName},
			#{item.remittanceTime},
			#{item.remittanceAmount},
			#{item.remittanceChannel},
			#{item.remittanceAccount},
			#{item.financialUser},
			#{item.financialTime},
			#{item.dealcode},
			#{item.remark},
			#{item.createDate},
			#{item.remittanceSerialNumber},
			#{item.accountStatus},
			#{item.updateDate},
			#{item.updateBy.id}
		)
		</foreach>


	</insert>


	<select id="findPaymentOrderByMobile" resultType="com.mo9.risk.modules.dunning.entity.DunningOrder" parameterType="java.util.List">
		SELECT
		o.dealcode AS "dealcode",
		b.mobile AS "mobile",
		idc.real_name AS "realname"
		FROM
		t_risk_order AS o
		LEFT JOIN t_risk_buyer AS b ON o.buyer_id = b.id
		LEFT JOIN t_risk_buyer_idcard AS idc ON idc.buyer_id = o.buyer_id
		WHERE
		o.merchant_id = 7
		AND o.`status`= 'payment'
		AND o.type = 'loan'
		AND b.mobile IN
		<foreach collection="list" index="mobile" open="(" separator="," close=")">
			#{mobile}
		</foreach>
	</select>

	<update id="batchUpdateMatched" >
		<foreach collection="list" item="item" index="index" open="" close="" separator=";">
			UPDATE t_mis_remittance_message
			<set>
				updatedate = now(),
				updateby = "sys",
				dealcode = #{item.dealcode},
				accountStatus = #{item.accountStatus},
				remittanceTag = #{item.remittanceTag}
			</set>
			WHERE id = #{item.id}
		</foreach>
	</update>

	<select id="findAfterFinancialTimeNotAuditList" resultType="TMisRemittanceMessage">
		SELECT
			<include refid="tMisRemittanceMessageColumns"/>
		FROM
			t_mis_remittance_message AS a
		WHERE
			accountStatus = "NOT_AUDIT"
		<if test="date != null">
			<![CDATA[
      	AND a.financialtime > #{date}
      ]]>
		</if>
	</select>
</mapper>