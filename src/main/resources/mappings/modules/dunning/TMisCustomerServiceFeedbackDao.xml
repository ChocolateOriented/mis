<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mo9.risk.modules.dunning.dao.TMisCustomerServiceFeedbackDao">
    <sql id="tMisCustomerServiceFeedbackColumns">
        a.dealcode AS "dealcode",
        a.type AS "type",
        a.status AS "status",
        a.problemStatus AS "problemstatus",
        a.hashtag AS "hashtag",
        a.problemdescription AS "problemdescription",
        a.updateDate AS "updateDate",
        a.updateBy AS "updateBy.name",
        a.pushpeople AS "pushpeople",
        a.operate AS "operate",
        a.handlingResult AS "handlingresult",
        a.rootOrderId AS "rootorderid"  ,
        a.uname AS "uname",
        a.keyword AS keyword,
        a.pushTime AS "pushTime",
        a.readFlag AS "readFlag",
        a.id AS "id"

    </sql>

    <select id="get" resultType="TMisCustomerServiceFeedback" useCache="false">
        SELECT
              <include refid="tMisCustomerServiceFeedbackColumns"/>
        FROM t_mis_customer_service_feedback a

        WHERE a.id = #{id}
    </select>

    <select id="findList" resultType="TMisCustomerServiceFeedback" useCache="false">
        SELECT
              <include refid="tMisCustomerServiceFeedbackColumns"/>,
              p.Nickname As "nickname"
        FROM t_mis_customer_service_feedback a
        LEFT JOIN t_risk_order r ON r.dealcode = a.dealcode
        LEFT JOIN t_mis_dunning_task t ON r.dealcode = t.dealcode
        LEFT JOIN t_mis_dunning_people p ON t.DunningPeopleId=p.id


        <where>
            r.buyer_id = #{buyerId}
        </where>

        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>

            </otherwise>
        </choose>
    </select>

    <select id="findCustServiceCount" resultType="java.lang.Integer" useCache="false">
         SELECT
              count(*)
         FROM t_mis_customer_service_feedback a
         INNER JOIN t_mis_dunning_task t ON a.dealcode = t.dealcode
         INNER JOIN t_mis_dunning_people p ON t.DunningPeopleId=p.id
         <where>
                <if test="readFlag != null and readFlag != ''">
                    AND a.readFlag = #{readFlag}
                </if>
                <if test="dunningpeopleid !=null and dunningpeopleid !=''">
                    AND t.DunningPeopleId=#{dunningpeopleid}
                </if>
         </where>
    </select>

    <select id="notifyList" resultType="TMisCustomerServiceFeedback" useCache="false">
        SELECT
             a.keyword,
             a.uname,
             a.dealcode,
             a.hashtag,
             a.problemStatus,
             a.pushpeople,
             a.pushTime,
             a.updateBy,
             a.id,
             a.readFlag,
             t.DunningPeopleId,
             p.groupId



        FROM t_mis_customer_service_feedback a
        LEFT JOIN t_mis_dunning_task t ON a.dealcode = t.dealcode
        LEFT JOIN t_mis_dunning_people p ON t.DunningPeopleId=p.id
        <where>

        <if test="keyword !=null and keyword!=''">
            AND (
                <!--a.keyword LIKE concat('%',#{keyword},'%')-->

                 a.uname LIKE concat('%',#{keyword},'%')
                OR a.dealcode LIKE concat('%',#{keyword},'%')
                OR a.problemdescription LIKE concat('%',#{keyword},'%')
                OR p.Nickname LIKE concat('%',#{keyword},'%')
                OR a.pushpeople LIKE concat('%',#{keyword},'%')
                OR p.name LIKE concat('%',#{keyword},'%')
                OR a.problemStatus =#{innerKeyWord}

            )
        </if>
        <!--<if test="uname !=null and uname!=''">-->
            <!--AND a.uname LIKE concat('%',#{uname},'%')-->
        <!--</if>-->
        <!--<if test="dealcode !=null and dealcode!=''">-->
            <!--AND a.dealcode LIKE concat('%',#{dealcode},'%')-->
        <!--</if>-->
        <if test="hashtag !=null and hashtag!=''">
            AND a.hashtag LIKE concat('%',#{hashtag},'%')
        </if>
        <if test="problemstatus !=null and problemstatus!='' ">
            <!--AND a.problemStatus LIKE concat('%',#{problemstatus},'%')-->
            AND a.problemStatus = #{problemstatus}
        </if>
        <!--<if test="pushpeople !=null and pushpeople !=''">-->
            <!--AND a.pushpeople LIKE  concat ('%',#{pushpeople},'%')-->
        <!--</if>-->
        <!--<if test="pushTime !=null and pushTime!=''">-->
            <!--AND a.pushTime=#{pushTime}-->
        <!--</if>-->
        <if test="farPushTime != null and nearPushTime != null and farPushTime != '' and nearPushTime != ''">
            AND a.pushTime BETWEEN #{farPushTime} AND #{nearPushTime}
        </if>
        <if test="updateBy !=null and updateBy !=''">
            AND a.updateBy LIKE  concat ('%',#{updateBy.name},'%')
        </if>
        <if test="groupIds != null">
            AND p.groupId in
            <if test="groupIds.size == 0">
                ('')
            </if>
            <if test="groupIds.size > 0">
                <foreach item="groupId" index="index" collection="groupIds" open="(" separator="," close=")">
                    #{groupId}
                </foreach>
            </if>
        </if>
        <if test="dunningpeopleid != null and dunningpeopleid != ''">
            AND t.DunningPeopleId = #{dunningpeopleid}
        </if>
        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </select>

    <select id="findCodeStatusTagDesPeople" resultType="TMisCustomerServiceFeedback" useCache="false">
        SELECT
             <include refid="tMisCustomerServiceFeedbackColumns"/>,
              c.Nickname As "nickname"
        FROM
        t_mis_customer_service_feedback a
        LEFT JOIN t_mis_dunning_task b ON a.dealcode = b.Dealcode
        LEFT JOIN t_mis_dunning_people c ON b.DunningPeopleId = c.Id
        WHERE a.id = #{id}
    </select>

    <insert id="insert">
        INSERT INTO t_mis_customer_service_feedback(
            id,
            dealcode,
            type,
            status,
            problemStatus,
            hashtag,
            problemdescription,
            updateDate,
            updateBy,
            pushpeople,
            operate,
            handlingResult,
            uname,
            keyword,
            pushTime,
            rootOrderId,
            readFlag
        )VALUES (
            #{id},
            #{dealcode},
            #{type},
            #{status},
            #{problemstatus},
            #{hashtag},
            #{problemdescription},
            #{updateDate},
            #{updateBy.name},
            #{pushpeople},
            #{operate},
            #{handlingresult},
            #{uname},
            #{keyword},
            #{pushTime},
            #{rootorderid},
            #{readFlag}
        )
    </insert>

    <update id="updateFeedback">
        UPDATE t_mis_customer_service_feedback SET
        problemStatus = #{problemstatus},
        handlingResult=CONCAT(
            handlingResult,
            #{handlingresult}
        ),
        updateDate=#{updateDate},
        updateBy=#{updateBy.name},
        readFlag=#{readFlag}
        WHERE id = #{id}
    </update>

    <update id="updateFlagByDealCode">
        <foreach collection="list" item="item" index="index" open="" close="" separator=";">
            UPDATE t_mis_customer_service_feedback
            SET readFlag='0'
            WHERE dealcode = #{item} AND problemStatus='UNRESOLVED'
        </foreach>
    </update>

    <update id="updateHandlingResult"  >
        <selectKey keyProperty='ids' resultType='String' order='BEFORE'>
            SELECT
            (select id FROM t_mis_customer_service_feedback  <where>
            hashTag LIKE CONCAT('%',#{hashtag},'%')
            AND dealcode = #{dealcode}
            AND problemStatus = 'UNRESOLVED'
            <if test="contactNumber !=null and contactNumber !=''">
                AND problemDescription LIKE CONCAT('%',#{contactNumber},'%')
            </if>
            AND handlingResult NOT LIKE CONCAT('%',#{handlingresult},'%') LIMIT 1
        </where>)id
            from DUAL
        </selectKey>
       UPDATE t_mis_customer_service_feedback
        SET
        handlingResult = CONCAT(
            handlingResult,
            #{handlingresult}
        ),
        <if test="nickname !=null and nickname !=''">
            updateBy=#{nickname},
        </if>
        updateDate=NOW()
        <where>
            hashTag LIKE CONCAT('%',#{hashtag},'%')
            AND dealcode = #{dealcode}
            AND problemStatus = 'UNRESOLVED'
            <if test="contactNumber !=null and contactNumber !=''">
                AND problemDescription LIKE CONCAT('%',#{contactNumber},'%')
            </if>
            AND handlingResult NOT LIKE CONCAT('%',#{handlingresult},'%') LIMIT 1
        </where>

    </update>
    <select id="getNameById" resultType="String">
        SELECT
	    Nickname AS  name
        FROM
            t_mis_dunning_people
        WHERE
            Id = #{id}
    </select>
    <update id="updateProblemStatus" parameterType="TMisCustomerServiceFeedback">
        UPDATE t_mis_customer_service_feedback
        SET
			problemStatus='RESOLVED'
        WHERE
         id=#{id}
    </update>
    <select id="findNickNameByDealcode" resultType="TMisCustomerServiceFeedback" useCache="false">
        SELECT
        <include refid="tMisCustomerServiceFeedbackColumns"/>,
        c.Nickname As "nickname"
        FROM
        t_mis_customer_service_feedback a
        LEFT JOIN t_mis_dunning_task b ON a.dealcode = b.Dealcode
        LEFT JOIN t_mis_dunning_people c ON b.DunningPeopleId = c.Id
        WHERE a.dealcode = #{dealcode}
    </select>
</mapper>